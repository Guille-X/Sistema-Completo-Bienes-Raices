import React, { useState, useEffect } from 'react';
import axios from 'axios';

const Referenciales = () => {
  const [documentosValuados, setDocumentosValuados] = useState([]);
  const [documentoSeleccionado, setDocumentoSeleccionado] = useState(null);
  const [foto, setFoto] = useState(null);
  const [departamento, setDepartamento] = useState('');
  const [municipio, setMunicipio] = useState('');

  const departamentos = {
  "Alta Verapaz": ["Cob√°n", "San Pedro Carch√°", "San Juan Chamelco", "San Crist√≥bal Verapaz", "Tactic", "Tamah√∫", "Tucur√∫", "Panz√≥s", "Senah√∫", "Cahab√≥n", "Lanqu√≠n", "Chahal", "Fray Bartolom√© de las Casas", "Chisec", "Santa Cruz Verapaz", "Santa Catalina La Tinta", "Raxruh√°"],
  "Baja Verapaz": ["Salam√°", "San Miguel Chicaj", "Rabinal", "Cubulco", "Granados", "El Chol", "San Jer√≥nimo", "Purulh√°"],
  "Chimaltenango": ["Chimaltenango", "San Jos√© Poaquil", "San Mart√≠n Jilotepeque", "Comalapa", "Santa Apolonia", "Tecp√°n Guatemala", "Patz√∫n", "Pochuta", "Patzic√≠a", "Santa Cruz Balany√°", "Acatenango", "Yepocapa", "San Andr√©s Itzapa", "Parramos", "Zaragoza", "El Tejar"],
  "Chiquimula": ["Chiquimula", "San Jos√© La Arada", "San Juan Ermita", "Jocot√°n", "Camot√°n", "Olopa", "Esquipulas", "Concepci√≥n Las Minas", "Quezaltepeque", "San Jacinto", "Ipala"],
  "El Progreso": ["Guastatoya", "Moraz√°n", "San Agust√≠n Acasaguastl√°n", "San Crist√≥bal Acasaguastl√°n", "El J√≠caro", "Sansare", "Sanarate", "San Antonio La Paz"],
  "Escuintla": ["Escuintla", "Santa Luc√≠a Cotzumalguapa", "La Democracia", "Siquinal√°", "Masagua", "Tiquisate", "La Gomera", "Guanagazapa", "San Jos√©", "Iztapa", "Pal√≠n", "San Vicente Pacaya", "Nueva Concepci√≥n"],
  "Guatemala": ["Guatemala", "Santa Catarina Pinula", "San Jos√© Pinula", "Mixco", "Villa Nueva", "Villa Canales", "Petapa", "Amatitl√°n", "Fraijanes", "San Raymundo", "Chinautla", "Chuarrancho", "San Pedro Ayampuc", "San Pedro Sacatep√©quez", "San Juan Sacatep√©quez"],
  "Huehuetenango": ["Huehuetenango", "Chiantla", "Malacatancito", "Cuilco", "Nent√≥n", "San Pedro Necta", "Jacaltenango", "Soloma", "San Ildefonso Ixtahuac√°n", "Santa B√°rbara", "La Libertad", "La Democracia", "San Miguel Acat√°n", "San Rafael La Independencia", "Todos Santos Cuchumat√°n", "San Juan Atit√°n", "Santa Eulalia", "San Mateo Ixtat√°n", "Colotenango", "San Sebasti√°n Huehuetenango", "Tectit√°n", "Concepci√≥n Huista", "San Juan Ixcoy", "San Antonio Huista", "San Sebasti√°n Coat√°n", "Barillas", "Aguacat√°n", "San Rafael Petzal", "San Gaspar Ixchil", "Santiago Chimaltenango", "Santa Ana Huista", "Uni√≥n Cantinil"],
  "Izabal": ["Puerto Barrios", "Livingston", "El Estor", "Morales", "Los Amates"],
  "Jalapa": ["Jalapa", "San Pedro Pinula", "San Luis Jilotepeque", "San Manuel Chaparr√≥n", "San Carlos Alzatate", "Monjas", "Mataquescuintla"],
  "Jutiapa": ["Jutiapa", "El Progreso", "Santa Catarina Mita", "Agua Blanca", "Asunci√≥n Mita", "Yupiltepeque", "Atescatempa", "Jerez", "El Adelanto", "Zapotitl√°n", "Comapa", "Jalpatagua", "Conguaco", "Moyuta", "Pasaco", "San Jos√© Acatempa", "Quesada"],
  "Pet√©n": ["Flores", "San Jos√©", "San Benito", "San Andr√©s", "La Libertad", "San Francisco", "Santa Ana", "Dolores", "San Luis", "Sayaxch√©", "Melchor de Mencos", "Popt√∫n", "Las Cruces", "El Chal"],
  "Quetzaltenango": ["Quetzaltenango", "Salcaj√°", "Olintepeque", "San Carlos Sija", "Sibilia", "Cabric√°n", "Cajol√°", "San Miguel Siguil√°", "Ostuncalco", "San Mateo", "Concepci√≥n Chiquirichapa", "San Mart√≠n Sacatep√©quez", "Almolonga", "Cantel", "Huit√°n", "Zunil", "Colomba", "San Francisco La Uni√≥n", "El Palmar", "Coatepeque", "G√©nova", "Flores Costa Cuca", "La Esperanza", "Palestina de Los Altos"],
  "Quich√©": ["Santa Cruz del Quich√©", "Chich√©", "Chinique", "Zacualpa", "Chajul", "Chichicastenango", "Patzit√©", "San Antonio Ilotenango", "San Pedro Jocopilas", "Cun√©n", "San Juan Cotzal", "Joyabaj", "Nebaj", "San Andr√©s Sajcabaj√°", "Uspant√°n", "Sacapulas", "San Bartolom√© Jocotenango", "Canill√°", "Chicam√°n", "Ixc√°n", "Pachalum"],
  "Retalhuleu": ["Retalhuleu", "San Sebasti√°n", "Santa Cruz Mulu√°", "San Mart√≠n Zapotitl√°n", "San Felipe", "San Andr√©s Villa Seca", "Champerico", "Nuevo San Carlos", "El Asintal"],
  "Sacatep√©quez": ["Antigua Guatemala", "Jocotenango", "Pastores", "Sumpango", "Santo Domingo Xenacoj", "Santiago Sacatep√©quez", "San Bartolom√© Milpas Altas", "San Lucas Sacatep√©quez", "Santa Luc√≠a Milpas Altas", "Magdalena Milpas Altas", "Santa Mar√≠a de Jes√∫s", "Ciudad Vieja", "San Miguel Due√±as", "Alotenango", "San Antonio Aguas Calientes", "Santa Catarina Barahona"],
  "San Marcos": ["San Marcos", "San Pedro Sacatep√©quez", "San Antonio Sacatep√©quez", "Comitancillo", "San Miguel Ixtahuac√°n", "Concepci√≥n Tutuapa", "Tacan√°", "Sibinal", "Tajumulco", "Tejutla", "San Rafael Pie de La Cuesta", "Nuevo Progreso", "El Tumbador", "El Rodeo", "Malacat√°n", "Catarina", "Ayutla", "Oc√≥s", "San Pablo", "El Quetzal", "La Reforma", "Pajapita", "Ixchigu√°n", "San Jos√© Ojetenam", "San Crist√≥bal Cucho", "Sipacapa", "Esquipulas Palo Gordo", "R√≠o Blanco", "San Lorenzo"],
  "Santa Rosa": ["Cuilapa", "Barberena", "Santa Rosa de Lima", "Casillas", "San Rafael Las Flores", "Oratorio", "San Juan Tecuaco", "Chiquimulilla", "Taxisco", "Santa Mar√≠a Ixhuat√°n", "Guazacap√°n", "Santa Cruz Naranjo", "Pueblo Nuevo Vi√±as", "Nueva Santa Rosa"],
  "Solol√°": ["Solol√°", "San Jos√© Chacay√°", "Santa Mar√≠a Visitaci√≥n", "Santa Luc√≠a Utatl√°n", "Nahual√°", "Santa Catarina Ixtahuac√°n", "Santa Clara La Laguna", "Concepci√≥n", "San Andr√©s Semetabaj", "Panajachel", "Santa Catarina Palop√≥", "San Antonio Palop√≥", "San Lucas Tolim√°n", "Santa Cruz La Laguna", "San Pablo La Laguna", "San Marcos La Laguna", "San Juan La Laguna", "San Pedro La Laguna", "Santiago Atitl√°n"],
  "Suchitep√©quez": ["Mazatenango", "Cuyotenango", "San Francisco Zapotitl√°n", "San Bernardino", "San Jos√© El Idolo", "Santo Domingo Suchitep√©quez", "San Lorenzo", "Samayac", "San Pablo Jocopilas", "San Antonio Suchitep√©quez", "San Miguel Pan√°n", "San Gabriel", "Chicacao", "Patulul", "Santa B√°rbara", "San Juan Bautista", "Santo Tom√°s La Uni√≥n", "Zunilito", "Pueblo Nuevo", "R√≠o Bravo"],
  "Totonicap√°n": ["Totonicap√°n", "San Crist√≥bal Totonicap√°n", "San Francisco El Alto", "San Andr√©s Xecul", "Momostenango", "Santa Mar√≠a Chiquimula", "Santa Luc√≠a La Reforma", "San Bartolo"],
  "Zacapa": ["Zacapa", "Estanzuela", "R√≠o Hondo", "Gual√°n", "Teculut√°n", "Usumatl√°n", "Caba√±as", "San Diego", "La Uni√≥n", "Huit√©"]
};





  const [referencial, setReferencial] = useState({
    link_fuente: '',
    valor_total: '',
    area_terreno: '',
    area_construccion: '',
    valor_construccion: ''
  });

  const [referenciales, setReferenciales] = useState([]);

  useEffect(() => {
    axios.get('http://localhost:3000/api/legal/factores/documentos-valuados')
      .then(res => setDocumentosValuados(res.data))
      .catch(err => console.error('Error al cargar documentos valuados:', err));
  }, []);

  useEffect(() => {
    if (documentoSeleccionado) {
      axios.get(`http://localhost:3000/api/legal/referenciales/${documentoSeleccionado.tipo_documento}/${documentoSeleccionado.id_documento}`)
        .then(res => setReferenciales(res.data))
        .catch(err => console.error('Error al cargar referenciales:', err));
    }
  }, [documentoSeleccionado]);

  const calcularValorSuelo = () => {
    const { valor_total, valor_construccion, area_terreno } = referencial;
    const suelo = parseFloat(valor_total || 0) - parseFloat(valor_construccion || 0);
    const suelo_m2 = suelo / parseFloat(area_terreno || 1);
    return {
      valor_suelo: suelo.toFixed(2),
      valor_suelo_m2: suelo_m2.toFixed(2)
    };
  };

  const handleChange = (e) => {
    setReferencial({ ...referencial, [e.target.name]: e.target.value });
  };

  const handleFileChange = (e) => {
    setFoto(e.target.files[0]);
  };

  const guardarReferencial = async () => {
    if (!documentoSeleccionado) return alert('Selecciona un documento valuado primero');

    const data = new FormData();
    data.append('id_documento', documentoSeleccionado.id_documento);
    data.append('tipo_documento', documentoSeleccionado.tipo_documento);
    data.append('departamento', departamento);
    data.append('municipio', municipio);
    Object.entries(referencial).forEach(([key, value]) => data.append(key, value));
    if (foto) data.append('foto', foto);
    
    try {
      await axios.post('http://localhost:3000/api/legal/referenciales/registrar', data);
      alert('Referencial guardado');
      setReferencial({
        link_fuente: '',
        valor_total: '',
        area_terreno: '',
        area_construccion: '',
        valor_construccion: ''
      });
      setFoto(null);
      const res = await axios.get(`http://localhost:3000/api/legal/referenciales/${documentoSeleccionado.tipo_documento}/${documentoSeleccionado.id_documento}`);
      setReferenciales(res.data);
    } catch (err) {
      console.error('Error al guardar referencial:', err);
      alert('No se pudo guardar');
    }
  };

  const { valor_suelo, valor_suelo_m2 } = calcularValorSuelo();

  return (
    <div style={{ marginTop: '2rem' }}>
      <h4>üèòÔ∏è Comparables referenciales</h4>

      <label>Selecciona un documento valuado:</label>
      <select onChange={(e) => {
        const [tipo, id] = e.target.value.split('|');
        setDocumentoSeleccionado({ tipo_documento: tipo, id_documento: parseInt(id) });
      }}>
        <option value="">‚Äî Seleccionar ‚Äî</option>
        {documentosValuados.map(doc => (
          <option key={`${doc.tipo_documento}-${doc.id_documento}`} value={`${doc.tipo_documento}|${doc.id_documento}`}>
            {doc.tipo_documento} #{doc.id_documento}
          </option>
        ))}
      </select>

      {documentoSeleccionado && (
        <>
          <h5 style={{ marginTop: '1rem' }}>üìã Registrar nuevo referencial</h5>
          <div style={{ display: 'grid', gap: '0.5rem', maxWidth: '600px' }}>
            <input name="link_fuente" placeholder="Link de la oferta" value={referencial.link_fuente} onChange={handleChange} />
            <input name="valor_total" placeholder="Valor total del inmueble" value={referencial.valor_total} onChange={handleChange} type="number" />
            <input name="area_terreno" placeholder="√Årea del terreno (m¬≤)" value={referencial.area_terreno} onChange={handleChange} type="number" />
            <input name="area_construccion" placeholder="√Årea construida (m¬≤)" value={referencial.area_construccion} onChange={handleChange} type="number" />
            <input name="valor_construccion" placeholder="Valor de construcci√≥n" value={referencial.valor_construccion} onChange={handleChange} type="number" />
            <select value={departamento} onChange={(e) => {setDepartamento(e.target.value);setMunicipio(''); // resetear municipio al cambiar departamento
            }}>
            <option value="">‚Äî Selecciona departamento ‚Äî</option>
            {Object.keys(departamentos).map(dep => (
            <option key={dep} value={dep}>{dep}</option>
            ))}
            </select>

            {departamento && (
            <select value={municipio} onChange={(e) => setMunicipio(e.target.value)}>
            <option value="">‚Äî Selecciona municipio ‚Äî</option>
            {departamentos[departamento].map(muni => (
            <option key={muni} value={muni}>{muni}</option>
            ))}
            </select>
            )}

            <div className="file-input-container">
            <label htmlFor="foto" className="file-label">
            üì∑ Seleccionar Imagen...
            </label>
            <input 
            type="file" 
            id="foto"
            name="foto" 
            accept="image/*" 
            onChange={handleFileChange}
            className="file-input"
            />
            </div>
            <div>üí° Valor del suelo: <strong>Q{valor_suelo}</strong></div>
            <div>üí° Valor del suelo/m¬≤: <strong>Q{valor_suelo_m2}</strong></div>
            <button onClick={guardarReferencial}>Guardar referencial</button>
          </div>

          {referenciales.length > 0 && (
            <div style={{ marginTop: '2rem' }}>
              <h5>üìÅ Referenciales registrados</h5>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead>
                  <tr>
                    <th>Link</th>
                    <th>Valor total</th>
                    <th>√Årea terreno</th>
                    <th>√Årea construcci√≥n</th>
                    <th>Valor construcci√≥n</th>
                    <th>Valor suelo</th>
                    <th>Valor suelo/m¬≤</th>
                    <th>Departamento</th>
                    <th>Municipio</th>
                    <th>Foto</th>
                  </tr>
                </thead>
                <tbody>
                  {referenciales.map((r) => (
                    <tr key={r.id}>
                      <td><a href={r.link_fuente} target="_blank" rel="noreferrer">Ver</a></td>
                      <td>Q{r.valor_total}</td>
                      <td>{r.area_terreno} m¬≤</td>
                      <td>{r.area_construccion} m¬≤</td>
                      <td>Q{r.valor_construccion}</td>
                      <td>Q{r.valor_suelo}</td>
                      <td>Q{r.valor_suelo_m2}</td>
                      <td>{r.departamento}</td>
                      <td>{r.municipio}</td>
                      <td>{r.foto_path ? (<a href={`http://localhost:3000${r.foto_path}`} target="_blank" rel="noreferrer">
                      <button className="foto-btn">
                      <span className="foto-icon">üñºÔ∏è</span>
                      Ver Foto
                      </button>
                      </a>) : ('‚Äî')}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </>
      )}
    </div>
  );
};

export default Referenciales;
